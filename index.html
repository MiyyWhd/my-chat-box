<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini Discord</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --bg-900:#202225; --bg-800:#2f3136; --bg-700:#36393f; --bg-600:#40444b; --primary:#7289da;
      --text:#dcddde; --text-soft:#b9bbbe; --danger:#ed4245; --success:#3ba55d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg-800); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex; min-height:100vh; overflow:hidden;
    }
    /* Left server rail */
    .servers{
      width:72px; background:var(--bg-900); padding:12px 8px; display:flex; flex-direction:column; gap:12px; align-items:center;
    }
    .server-dot{
      width:48px; height:48px; border-radius:16px; background:var(--bg-700); display:grid; place-items:center;
      cursor:pointer; transition:transform .1s, background .2s, box-shadow .2s;
      user-select:none; font-weight:700;
    }
    .server-dot.active{ background:var(--primary); box-shadow:0 0 0 2px rgba(0,0,0,.2) inset; }
    .server-dot:hover{ transform:translateY(-1px) }
    /* Channel column */
    .channels{
      width:260px; background:var(--bg-900); display:flex; flex-direction:column; border-right:1px solid #00000020;
    }
    .channels .header{
      padding:12px; border-bottom:1px solid #00000020; font-weight:700;
    }
    .channel-list{ padding:8px; overflow:auto }
    .chan{
      padding:8px 10px; border-radius:6px; color:var(--text-soft); display:flex; align-items:center; gap:8px; cursor:pointer;
    }
    .chan.active{ background:var(--bg-700); color:#fff }
    .chan:hover{ background:var(--bg-600); color:#fff }
    /* Main chat area */
    .chat{
      flex:1; display:flex; flex-direction:column; background:var(--bg-700);
    }
    .chat .topbar{
      height:48px; border-bottom:1px solid #00000020; display:flex; align-items:center; gap:10px; padding:0 16px;
      background:var(--bg-700); position:sticky; top:0; z-index:10;
    }
    .hash{ color:var(--text-soft) }
    .title{ font-weight:700 }
    .messages{
      flex:1; overflow:auto; padding:16px;
    }
    .msg{
      margin-bottom:12px; line-height:1.3;
    }
    .msg .meta{
      display:flex; align-items:baseline; gap:8px; margin-bottom:2px;
    }
    .msg .author{ font-weight:700; color:#fff }
    .msg .time{ font-size:12px; color:var(--text-soft) }
    .msg .text{ white-space:pre-wrap; color:var(--text) }
    .msg.system .author{ color:var(--primary) }
    .composer{
      padding:12px; border-top:1px solid #00000020; background:var(--bg-700); display:flex; gap:10px;
    }
    .composer input{
      flex:1; background:var(--bg-600); border:none; outline:none; color:#fff; padding:12px; border-radius:8px;
    }
    .composer button{
      background:var(--primary); color:#fff; border:none; padding:0 16px; border-radius:8px; cursor:pointer; font-weight:600;
    }
    .composer button:disabled{ opacity:.6; cursor:not-allowed }
    /* Members Sidebar */
    .members{
      width:240px; background:var(--bg-900); border-left:1px solid #00000020;
      display:flex; flex-direction:column; overflow:auto;
    }
    .members .section{
      padding:8px 12px; font-size:12px; font-weight:700; color:var(--text-soft);
    }
    .member{
      display:flex; align-items:center; gap:10px; padding:6px 12px; border-radius:6px;
    }
    .member:hover{ background:var(--bg-600); }
    .avatar{
      width:32px; height:32px; border-radius:50%; background:var(--bg-700); flex-shrink:0;
      position:relative; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600;
    }
    .status{
      position:absolute; bottom:0; right:0; width:10px; height:10px; border:2px solid var(--bg-900); border-radius:50%;
    }
    .status.online{ background:var(--success); }
    .status.offline{ background:var(--danger); }
    /* Small screens */
    @media (max-width:900px){
      .servers{ display:none }
      .channels{ width:200px }
      .members{ display:none }
    }
  </style>
</head>
<body>
  <!-- Servers rail -->
  <aside class="servers" id="servers">
    <div class="server-dot active" data-server="home" title="Home">H</div>
    <div class="server-dot" data-server="games" title="Games">G</div>
    <div class="server-dot" data-server="study" title="Study">S</div>
    <div class="server-dot" data-server="music" title="Music">M</div>
  </aside>

  <!-- Channels column -->
  <aside class="channels">
    <div class="header">Channels</div>
    <div class="channel-list" id="channelList"></div>
  </aside>

  <!-- Main chat -->
  <main class="chat">
    <div class="topbar">
      <span class="hash">#</span><span class="title" id="roomTitle">general</span>
    </div>
    <div class="messages" id="messages"></div>
    <div class="composer">
      <input id="messageInput" placeholder="Message #general" />
      <button id="sendBtn">Send</button>
    </div>
  </main>

  <!-- Members sidebar -->
  <aside class="members" id="members"></aside>

  <script>
    // ---- Client state ----
    const socket = io();
    const defaultServer = "home";
    const serverChannels = {
      home:   ["general", "random", "announcements"],
      games:  ["general", "lobby", "mmorpg"],
      study:  ["general", "assignments", "resources"],
      music:  ["general", "recommendations", "live-chat"]
    };

    let currentServer = defaultServer;
    let currentRoom = "general";
    let currentUser = "User" + Math.floor(Math.random()*1000);

    // ---- DOM refs ----
    const channelList = document.getElementById("channelList");
    const roomTitle = document.getElementById("roomTitle");
    const msgBox = document.getElementById("messages");
    const inputEl = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const membersBox = document.getElementById("members");

    // ---- Helpers ----
    function fmtTime(ts){
      const d = new Date(ts);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }
    function scrollToBottom(){ msgBox.scrollTop = msgBox.scrollHeight; }
    function setPlaceholder(){
      inputEl.placeholder = `Message #${currentRoom}`;
      roomTitle.textContent = currentRoom;
    }
    function el(tag, cls, text){
      const e = document.createElement(tag);
      if (cls) e.className = cls;
      if (text) e.textContent = text;
      return e;
    }
    function renderChannels(){
      channelList.innerHTML = "";
      const chans = serverChannels[currentServer] || [];
      chans.forEach(ch => {
        const row = el("div", "chan" + (ch===currentRoom?" active":""), "");
        row.innerHTML = `<span>#</span><span>${ch}</span>`;
        row.onclick = () => changeRoom(ch);
        channelList.appendChild(row);
      });
    }
    function setActiveServerDot(){
      document.querySelectorAll(".server-dot").forEach(dot=>{
        dot.classList.toggle("active", dot.dataset.server === currentServer);
      });
    }

    // ---- Members rendering ----
    function renderMembers(list){
      membersBox.innerHTML = "";
      const online = list.filter(u=>u.online);
      const offline = list.filter(u=>!u.online);

      if (online.length){
        membersBox.appendChild(el("div","section","ONLINE — "+online.length));
        online.forEach(user => membersBox.appendChild(makeMember(user)));
      }
      if (offline.length){
        membersBox.appendChild(el("div","section","OFFLINE — "+offline.length));
        offline.forEach(user => membersBox.appendChild(makeMember(user)));
      }
    }
    function makeMember(user){
      const row = el("div","member","");
      const avatar = el("div","avatar",user.name[0].toUpperCase());
      const status = el("div","status " + (user.online?"online":"offline"));
      avatar.appendChild(status);
      row.appendChild(avatar);
      row.appendChild(el("div","",user.name));
      return row;
    }

    // ---- Room changes ----
    function join(room){
      socket.emit("join", { room, user: currentUser });
      msgBox.innerHTML = "";
      setPlaceholder();
      scrollToBottom();
    }
    function changeRoom(room){
      currentRoom = room;
      renderChannels();
      join(room);
    }

    // ---- Send message ----
    function send(){
      const text = inputEl.value.trim();
      if (!text) return;
      socket.emit("chat", { room: currentRoom, user: currentUser, text });
      inputEl.value = "";
    }

    // ---- Socket events ----
    socket.on("chat", (msg) => {
      if (msg.room !== currentRoom) return;
      const wrap = el("div", "msg");
      const meta = el("div", "meta");
      meta.appendChild(el("span", "author", msg.user));
      meta.appendChild(el("span", "time", fmtTime(msg.ts || Date.now())));
      wrap.appendChild(meta);
      wrap.appendChild(el("div", "text", msg.text));
      msgBox.appendChild(wrap);
      scrollToBottom();
    });

    socket.on("system", (msg) => {
      if (msg.room !== currentRoom) return;
      const wrap = el("div", "msg system");
      const meta = el("div", "meta");
      meta.appendChild(el("span", "author", "System"));
      meta.appendChild(el("span", "time", fmtTime(msg.ts || Date.now())));
      wrap.appendChild(meta);
      wrap.appendChild(el("div", "text", msg.text));
      msgBox.appendChild(wrap);
      scrollToBottom();
    });

    socket.on("members", (list)=>{
      renderMembers(list);
    });

    // ---- UI wiring ----
    sendBtn.onclick = send;
    inputEl.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    // Server rail click
    document.getElementById("servers").addEventListener("click", (e)=>{
      const dot = e.target.closest(".server-dot");
      if (!dot) return;
      const targetServer = dot.dataset.server;
      if (targetServer === currentServer) return;
      currentServer = targetServer;
      setActiveServerDot();
      currentRoom = (serverChannels[currentServer] && serverChannels[currentServer][0]) || "general";
      renderChannels();
      join(currentRoom);
    });

    // ---- Boot ----
    setActiveServerDot();
    renderChannels();
    join(currentRoom);
    setPlaceholder();
  </script>
</body>
</html>
